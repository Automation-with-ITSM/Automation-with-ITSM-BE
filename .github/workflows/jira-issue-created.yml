name: Create GitHub Issue from Jira

on:
  repository_dispatch:
    types: [jira-issue]

permissions:
  contents: read
  issues: write

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Render template and create issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const p = context.payload.client_payload || {};
            const kind = (p.kind || '').toLowerCase();

            // --- helpers ---
            const esc = (s) => (s ?? '').toString();
            const nz  = (s, fallback='') => {
              const v = (s ?? '').toString().trim();
              return v.length ? v : fallback;
            };
            const decodeMaybe = (s) => {
              const str = esc(s);
              try { return /%[0-9A-Fa-f]{2}/.test(str) ? decodeURIComponent(str) : str; }
              catch { return str; }
            };

            // 1) í…œí”Œë¦¿ ì„ íƒ
            const mapping = {
              story: '.github/ISSUE_TEMPLATE/automation-story.md',
              bug:   '.github/ISSUE_TEMPLATE/automation-bug.md',
              task:  '.github/ISSUE_TEMPLATE/automation-task.md'
            };
            const file = mapping[kind] || mapping.task;
            const templatePath = path.join(process.cwd(), file);
            if (!fs.existsSync(templatePath)) {
              core.setFailed(`Template not found: ${file}`);
              return;
            }
            const tpl = fs.readFileSync(templatePath, 'utf8');

            // 2) ê°’ ì¤€ë¹„
            const key         = esc(p.key);
            const url         = esc(p.url);
            const summary     = esc(p.summary);
            const description = esc(p.description);
            const priority    = esc(p.priority);
            const duedate     = nz(p.duedate, 'ë¯¸ì •');
            const checklist   = decodeMaybe(p.checklist);

            // 3) í…œí”Œë¦¿ ì¹˜í™˜
            let body = tpl
              .replaceAll('{{issue.key}}', key)
              .replaceAll('{{key}}', key)
              .replaceAll('{{issue.url}}', url)
              .replaceAll('{{url}}', url)
              .replaceAll('{{issue.summary}}', summary)
              .replaceAll('{{summary}}', summary)
              .replaceAll('{{description}}', description)
              .replaceAll('{{priority}}', priority)
              .replaceAll('{{issue.duedate}}', duedate)
              .replaceAll('{{duedate}}', duedate)
              .replaceAll('{{checklist}}', checklist || '');

            if (checklist && !tpl.includes('{{checklist}}')) {
              body += `\n\n---\n\n## âœ… To-Do\n${checklist}\n`;
            }

            // 4) ë¼ë²¨ ê²°ì •
            const allowed = new Set(['Feature','Refactor','Documentation']);
            let labels = [];
            if (kind === 'story') labels = ['Story'];
            else if (kind === 'bug') labels = ['Bug'];
            else {
              let incoming = [];
              if (Array.isArray(p.labels)) incoming = p.labels;
              else if (typeof p.labels === 'string') {
                try {
                  const parsed = JSON.parse(p.labels);
                  if (Array.isArray(parsed)) incoming = parsed;
                  else incoming = p.labels.split(',').map(s=>s.trim()).filter(Boolean);
                } catch {
                  incoming = p.labels.split(',').map(s=>s.trim()).filter(Boolean);
                }
              }
              labels = incoming.filter(v => allowed.has(v));
              if (labels.length === 0) labels = ['Task'];
            }

            // 5) ì´ìŠˆ ìƒì„±
            const title = `[${key}] ${summary}`;
            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels
            });

            // âœ… ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©
            core.setOutput('number', res.data.number); // JS ì£¼ì„ìœ¼ë¡œ!
            core.info(`Created issue #${res.data.number}`);

      - name: Comment branch link
        if: ${{ success() }}
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.create_issue.outputs.number }}   # âœ… envë¡œ ì£¼ìž…
        with:
          script: |
            const p = context.payload.client_payload || {};
            const issue_number = Number(process.env.ISSUE_NUMBER || 0); // âœ… envì—ì„œ ì½ê¸°
            const esc = (s) => (s ?? '').toString();

            // 1) payload.branch ìš°ì„ 
            let branch = esc(p.branch).trim();

            // 2) payloadì— ì—†ìœ¼ë©´ ê·œì¹™ ê¸°ë°˜ ì¶”ë¡ 
            const key  = esc(p.key);
            const kind = esc(p.kind).toLowerCase();
            if (!branch && key) {
              if (kind.startsWith('bug')) branch = `bug/${key}`;
              else if (kind.startsWith('story')) branch = `story/${key}`;
              else {
                let labels = [];
                if (Array.isArray(p.labels)) labels = p.labels;
                else if (typeof p.labels === 'string') {
                  try {
                    const parsed = JSON.parse(p.labels);
                    if (Array.isArray(parsed)) labels = parsed;
                    else labels = p.labels.split(',').map(s=>s.trim()).filter(Boolean);
                  } catch {
                    labels = p.labels.split(',').map(s=>s.trim()).filter(Boolean);
                  }
                }
                const set = new Set(labels.map(v => v.toString().toLowerCase()));
                if (set.has('feature')) branch = `feature/${key}`;
                else if (set.has('refactor')) branch = `refactor/${key}`;
                else if (set.has('documentation')) branch = `documentation/${key}`;
                else branch = `task/${key}`;
              }
            }

            if (!branch || !issue_number) {
              core.info(`No branch or issue_number to comment. Skip. branch='${branch}', issue_number='${issue_number}'`);
              return;
            }

            const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/tree/${encodeURIComponent(branch)}`;

            // í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ëŒ€ì‹  ì•ˆì „ ì¡°ë¦½
            const bodyLines = [
              'ðŸŒ¿ **Branch:** `' + branch + '`',
              '',
              '[Open branch](' + url + ')',
              '',
              '> Tip: Add `Fixes #' + issue_number + '` in your PR to auto-close this issue.'
            ];
            const commentBody = bodyLines.join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: commentBody
            });

            core.info(`Added branch comment to issue #${issue_number}: ${branch}`);
