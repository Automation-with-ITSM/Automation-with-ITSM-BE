name: Create GitHub Issue from Jira

on:
  repository_dispatch:
    types: [jira-issue]

permissions:
  contents: read
  issues: write

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Render template and create issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          # result를 문자열로 돌려받아 다음 스텝에서 steps.create_issue.outputs.result 로 사용
          result-encoding: string
          script: |
            const fs = require('fs');
            const path = require('path');

            const p = context.payload.client_payload || {};
            const kind = (p.kind || '').toLowerCase();

            const esc = (s) => (s ?? '').toString();
            const nz  = (s, fallback='') => { const v = (s ?? '').toString().trim(); return v.length ? v : fallback; };
            const decodeMaybe = (s) => { const str = esc(s); try { return /%[0-9A-Fa-f]{2}/.test(str) ? decodeURIComponent(str) : str; } catch { return str; } };

            const mapping = {
              story: '.github/ISSUE_TEMPLATE/automation-story.md',
              bug:   '.github/ISSUE_TEMPLATE/automation-bug.md',
              task:  '.github/ISSUE_TEMPLATE/automation-task.md'
            };
            const file = mapping[kind] || mapping.task;
            const templatePath = path.join(process.cwd(), file);
            if (!fs.existsSync(templatePath)) {
              core.setFailed(`Template not found: ${file}`);
              return;
            }
            const tpl = fs.readFileSync(templatePath, 'utf8');

            const key         = esc(p.key);
            const url         = esc(p.url);
            const summary     = esc(p.summary);
            const description = esc(p.description);
            const priority    = esc(p.priority);
            const duedate     = nz(p.duedate, '미정');
            const checklist   = decodeMaybe(p.checklist);

            let body = tpl
              .replaceAll('{{issue.key}}', key)
              .replaceAll('{{key}}', key)
              .replaceAll('{{issue.url}}', url)
              .replaceAll('{{url}}', url)
              .replaceAll('{{issue.summary}}', summary)
              .replaceAll('{{summary}}', summary)
              .replaceAll('{{description}}', description)
              .replaceAll('{{priority}}', priority)
              .replaceAll('{{issue.duedate}}', duedate)
              .replaceAll('{{duedate}}', duedate)
              .replaceAll('{{checklist}}', checklist || '');

            if (checklist && !tpl.includes('{{checklist}}')) {
              body += `\n\n---\n\n## ✅ To-Do\n${checklist}\n`;
            }

            const allowed = new Set(['Feature','Refactor','Documentation']);
            let labels = [];
            if (kind === 'story') labels = ['Story'];
            else if (kind === 'bug') labels = ['Bug'];
            else {
              let incoming = [];
              if (Array.isArray(p.labels)) incoming = p.labels;
              else if (typeof p.labels === 'string') {
                try { const parsed = JSON.parse(p.labels); if (Array.isArray(parsed)) incoming = parsed; }
                catch { incoming = p.labels.split(',').map(s=>s.trim()).filter(Boolean); }
              }
              labels = incoming.filter(v => allowed.has(v));
              if (labels.length === 0) labels = ['Task'];
            }

            const title = `[${key}] ${summary}`;
            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels
            });

            core.info(`Created issue #${res.data.number}`);
            // ✅ 이 값을 다음 스텝에서 steps.create_issue.outputs.result 로 받는다
            return String(res.data.number);

      - name: Assign mapped GitHub users
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const p = context.payload.client_payload || {};
            const issue_number = Number('${{ steps.create_issue.outputs.result }}');
            if (!issue_number) {
              core.info('No issue number. Skip assignees.');
              return;
            }

            // 매핑 파일 읽기
            const mapPath = path.join(process.cwd(), '.github/jira-gh-user-map.json');
            if (!fs.existsSync(mapPath)) {
              core.info('Mapping file not found. Skip assigning.');
              return;
            }
            let mapping = {};
            try {
              mapping = JSON.parse(fs.readFileSync(mapPath, 'utf8'));
            } catch (e) {
              core.warning(`Failed to parse mapping file: ${e.message}`);
              return;
            }

            // Jira payload에서 이메일 우선, 없으면 displayName로 fallback 하고 싶으면 여기에 추가
            const email = (p.assigneeEmail || '').trim().toLowerCase();
            const assignees = [];
            if (email && mapping[email]) {
              assignees.push(mapping[email]);
            } else {
              core.info(`No mapping for assigneeEmail "${email}"`);
            }

            if (assignees.length === 0) {
              core.info('No mapped assignees. Skip.');
              return;
            }

            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                assignees
              });
              core.info(`Assigned: ${assignees.join(', ')}`);
            } catch (e) {
              core.warning(`Failed to add assignees: ${e.status} ${e.message}`);
            }
